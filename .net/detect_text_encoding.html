<!doctype html>
<html lang='en'>
<head>
<meta charset='utf-8' name='viewport' content='width=device-width, initial-scale=1.0'>
<title>{{title}}</title>
</head>
<body>
<style>
body {
  max-width:70ch;
  padding:2ch;
  margin:auto;
  color:#333;
  font-size:1.2em;
}
</style>
<h1 id="detect-the-encoding-of-a-file">Detect the encoding of a file</h1>
<p>Well this is a doozy, and bound to require constant upkeep.</p>
<p>I always start off reading files like this...</p>
<pre><code>using (var sr = new StreamReader(fileName))
</code></pre>
<p>Then, someone complains that their non-ascii files weren't read correctly, I ask for example files, perform some tests and end up with this:</p>
<pre><code>using (var sr = new StreamReader(fileName, System.Text.Encoding.UTF8))
</code></pre>
<p>It works for a while, then I receive more complaints and more test files. I see that it doesn't work for the new test files. Hmm.</p>
<p>I studiously avoid thinking about <a href="https://www.joelonsoftware.com/2003/10/08/the-absolute-minimum-every-software-developer-absolutely-positively-must-know-about-unicode-and-character-sets-no-excuses/">&quot;The Absolute Minimum Every Software Developer Absolutely, Positively Must Know About Unicode and Character Sets (No Excuses!)&quot;</a>.</p>
<p>I can open the file in NotePad++ and see under the conveniently named &quot;Encoding&quot; menu, exactly which encoding NotePad++ decides on for a given file.</p>
<p>Then I go to stack overflow and find an answer, with a lot of upvotes, which almost works for me.</p>
<p>Only change I had to make is highlighted below:</p>
<pre><code>/// &lt;summary&gt;
/// Determines a text file's encoding by analyzing its byte order mark (BOM).
/// Defaults to ASCII when detection of the text file's endianness fails.
/// &lt;/summary&gt;
/// &lt;param name=&quot;filename&quot;&gt;The text file to analyze.&lt;/param&gt;
/// &lt;returns&gt;The detected encoding.&lt;/returns&gt;
private static Encoding GetEncoding(string filename)
{
    // Read the BOM
    var bom = new byte[4];
    using (var file = new FileStream(filename, FileMode.Open, FileAccess.Read))
    {
        file.Read(bom, 0, 4);
    }

    // Analyze the BOM
    if (bom[0] == 0x2b &amp;&amp; bom[1] == 0x2f &amp;&amp; bom[2] == 0x76) return Encoding.UTF7;
    if (bom[0] == 0xef &amp;&amp; bom[1] == 0xbb &amp;&amp; bom[2] == 0xbf) return Encoding.UTF8;
    if (bom[0] == 0xff &amp;&amp; bom[1] == 0xfe) return Encoding.Unicode; //UTF-16LE
    if (bom[0] == 0xfe &amp;&amp; bom[1] == 0xff) return Encoding.BigEndianUnicode; //UTF-16BE
    if (bom[0] == 0 &amp;&amp; bom[1] == 0 &amp;&amp; bom[2] == 0xfe &amp;&amp; bom[3] == 0xff) return Encoding.UTF32;
    return Encoding.Default; // **Changed this line**
}
</code></pre>
<p>And use it thus:</p>
<pre><code>var encoding = GetEncoding(fileName);
using (var sr = new StreamReader(fileName, encoding)) // System.Text.Encoding.UTF8))
</code></pre>
<p>I am certain this will require further changes in future.</p>
<h2 id="source">Source</h2>
<ul>
<li><a href="http://stackoverflow.com/questions/3825390/effective-way-to-find-any-files-encoding">Stack Overflow: Effective way to find any file's Encoding</a></li>
<li><a href="https://www.joelonsoftware.com/2003/10/08/the-absolute-minimum-every-software-developer-absolutely-positively-must-know-about-unicode-and-character-sets-no-excuses/">&quot;The Absolute Minimum Every Software Developer Absolutely, Positively Must Know About Unicode and Character Sets (No Excuses!)&quot;</a></li>
<li><a href="http://reedbeta.com/blog/programmers-intro-to-unicode/">A Programmer's Introduction to Unicode</a></li>
<li><a href="https://medium.com/@keithgabryelski/a-practical-guide-to-character-sets-and-encodings-b5362447456f#.dn0guodnz">A Practical Guide to Character Sets and Encodings</a></li>
</ul>

</body>
<script>
</script>
</html>